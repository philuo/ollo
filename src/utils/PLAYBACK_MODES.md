# 播放模式说明

## 🔁 新功能：循环播放 vs 播放一次

### 概述

动画预览现在支持两种播放模式，让你可以根据不同需求选择合适的播放方式。

---

## 📋 两种播放模式

### 1️⃣ 循环播放（Loop）🔁

**默认模式**

- ✅ 动画持续循环播放
- ✅ 从第一帧到最后一帧，然后回到第一帧
- ✅ 无限重复，直到手动停止
- ✅ 适合查看动画的连续性和流畅度

**使用场景：**
```
• 角色奔跑动画（需要连续循环）
• 待机动画（持续播放）
• 火焰、水流等循环效果
• 检查动画是否流畅衔接
```

**行为：**
```
帧序列: [0, 1, 2, 3, 4]

循环播放:
0 → 1 → 2 → 3 → 4 → 0 → 1 → 2 → 3 → 4 → 0 → ...
└────────────────────┘   └────────────────────┘
     第一轮循环              第二轮循环
```

---

### 2️⃣ 播放一次（Once）▶️

**单次播放模式**

- ✅ 动画播放一次后自动停止
- ✅ 从第一帧播放到最后一帧
- ✅ 播放完成后停在最后一帧
- ✅ 适合查看单次动作效果

**使用场景：**
```
• 攻击动作（播放一次）
• 跳跃动画（单次动作）
• 技能释放效果
• 检查动画的开始和结束
• 截取最后一帧作为预览图
```

**行为：**
```
帧序列: [0, 1, 2, 3, 4]

播放一次:
0 → 1 → 2 → 3 → 4 [停止]
└────────────────────┘
   播放完成，停在帧4
```

---

## 🎮 使用方法

### UI 控件

```
┌─────────────────────────────┐
│ 播放模式:                   │
│ ┌─────────────────────────┐ │
│ │ 🔁 循环播放（默认）     ▼│ │
│ └─────────────────────────┘ │
│   • 循环播放（默认）         │
│   • 播放一次                 │
└─────────────────────────────┘
```

### 操作步骤

1. **选择帧序列**
   - 行选模式：选择一整行
   - 列选模式：选择一整列
   - 多选模式：选择多个网格

2. **选择播放模式**
   - 🔁 循环播放（默认）
   - ▶️ 播放一次

3. **点击播放按钮**
   - 循环模式：持续播放，点击"暂停"停止
   - 单次模式：播放一次后自动停止

4. **观察效果**
   - 循环模式：动画无限循环
   - 单次模式：播放到最后一帧自动停止

---

## 🔧 技术实现

### 状态管理

```typescript
const [playMode, setPlayMode] = createSignal<'loop' | 'once'>('loop');
```

### 播放逻辑

```typescript
const animate = (currentTime: number) => {
  const totalFrames = getSelectedFrames().length;
  const currentFrameIndex = currentFrame();
  const nextFrameIndex = currentFrameIndex + 1;
  
  // 检查播放模式
  if (playMode() === 'once' && nextFrameIndex >= totalFrames) {
    // 单次播放：到达最后一帧后停止
    setCurrentFrame(totalFrames - 1);
    drawAnimationFrame(totalFrames - 1);
    stopAnimation();
    console.log('动画播放完成（单次模式）');
    return;
  }
  
  // 循环模式：继续下一帧
  const newFrameIndex = nextFrameIndex % totalFrames;
  setCurrentFrame(newFrameIndex);
  drawAnimationFrame(newFrameIndex);
};
```

### 关键点

1. **模式检测**
   ```typescript
   if (playMode() === 'once' && nextFrameIndex >= totalFrames)
   ```

2. **停止条件**
   - 单次模式：`nextFrameIndex >= totalFrames`
   - 循环模式：无停止条件（除非手动暂停）

3. **最后一帧处理**
   ```typescript
   setCurrentFrame(totalFrames - 1); // 停在最后一帧
   drawAnimationFrame(totalFrames - 1);
   stopAnimation();
   ```

---

## 📊 功能对比

| 特性 | 循环播放 🔁 | 播放一次 ▶️ |
|------|-------------|-------------|
| **默认模式** | ✅ 是 | ❌ 否 |
| **自动停止** | ❌ 否 | ✅ 是 |
| **重复播放** | ✅ 无限 | ❌ 仅一次 |
| **停止位置** | 手动暂停位置 | 最后一帧 |
| **适用场景** | 循环动作、检查流畅度 | 单次动作、检查结束帧 |
| **使用频率** | 高（默认） | 中 |

---

## 💡 使用建议

### 循环播放 🔁

**推荐用于：**
- ✅ 检查动画循环是否流畅
- ✅ 查看首尾帧是否衔接
- ✅ 长时间观察动画效果
- ✅ 调试帧率和速度

**示例：**
```
场景：角色奔跑动画
- 选择第1行（奔跑序列）
- 设置为"循环播放"
- 观察是否有跳帧或不流畅
- 检查首尾帧是否完美衔接
```

### 播放一次 ▶️

**推荐用于：**
- ✅ 查看单次动作效果
- ✅ 检查最后一帧的状态
- ✅ 截取关键帧
- ✅ 精确控制播放次数

**示例：**
```
场景：攻击动作动画
- 选择攻击序列
- 设置为"播放一次"
- 观察动作从开始到结束
- 检查最后一帧是否合适作为结束姿势
```

---

## 🎯 实际应用

### 场景 1: 检查循环动画

```
任务：确保奔跑动画完美循环

步骤：
1. 选择奔跑动画行
2. 选择"🔁 循环播放"
3. 点击播放
4. 观察首尾帧衔接
5. 如果有跳跃，调整最后一帧

结果：流畅的循环动画 ✅
```

### 场景 2: 检查单次动作

```
任务：确认跳跃动作的结束姿势

步骤：
1. 选择跳跃动画列
2. 选择"▶️ 播放一次"
3. 点击播放
4. 动画自动停在最后一帧
5. 检查着地姿势是否自然

结果：完美的着地姿势 ✅
```

### 场景 3: 对比两种模式

```
任务：决定动画应该循环还是单次

循环模式测试：
- 设置为"循环播放"
- 观察是否适合无限重复
- 检查是否有违和感

单次模式测试：
- 设置为"播放一次"
- 观察单次效果
- 检查结束状态

决策：根据实际效果选择合适模式
```

---

## 🔍 调试技巧

### 1. 快速切换模式

```
问题：不确定应该用哪种模式

方法：
1. 先用"循环播放"观察整体效果
2. 切换到"播放一次"检查结束帧
3. 根据需求选择最终模式
```

### 2. 检查首尾衔接

```
问题：循环动画有跳跃感

方法：
1. 设置为"循环播放"
2. 重点观察从最后一帧到第一帧的过渡
3. 如果不流畅，调整首尾帧
4. 重新播放验证
```

### 3. 捕获关键帧

```
问题：需要截取最后一帧作为预览图

方法：
1. 设置为"播放一次"
2. 点击播放
3. 动画自动停在最后一帧
4. 使用截图工具捕获
```

---

## ✅ 功能清单

- ✅ 循环播放模式（默认）
- ✅ 播放一次模式
- ✅ 下拉选择器切换
- ✅ 单次模式自动停止
- ✅ 停在最后一帧
- ✅ 控制台输出完成信息
- ✅ 与现有播放控制完美集成
- ✅ 支持所有选择模式（行/列/多选）
- ✅ 响应式更新
- ✅ 清晰的 UI 图标（🔁 / ▶️）

---

## 🚀 总结

播放模式功能为动画预览提供了更灵活的控制方式：

- **循环播放** 🔁 - 适合持续观察和检查循环性
- **播放一次** ▶️ - 适合单次动作和精确控制

默认使用**循环播放**，符合大多数使用习惯。需要时可随时切换到**播放一次**模式。

这个功能让雪碧图合成工具的动画预览系统更加**专业和实用**！🎨✨

