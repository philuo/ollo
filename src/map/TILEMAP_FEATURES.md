# TileMap 编辑器 - 新功能说明

## ✅ Bug 修复和新功能

### 1. 修复了 WebGPU 初始化问题 ✅

**问题**：
- 缺少错误提示
- 渲染循环可能未正确启动

**修复**：
- 添加详细的错误提示
- 改进 WebGPU 初始化流程
- 确保渲染循环正确启动
- 添加浏览器兼容性检查

### 2. 网格设置面板 ✅

**功能**：自动识别瓦片集后，可手动调整网格参数

**使用方法**：
1. 上传瓦片集图片
2. 系统自动识别网格并显示设置面板
3. 手动调整参数：
   - **瓦片宽度** - 单个瓦片的宽度（像素）
   - **瓦片高度** - 单个瓦片的高度（像素）
   - **间距** - 瓦片之间的间隔
   - **边距** - 图片边缘的留白
4. 系统自动计算：
   - **列数** - 根据图片宽度自动计算
   - **行数** - 根据图片高度自动计算
5. 点击"应用设置"更新网格

**示例**：
```
上传图片：tileset.png (512x384)
自动识别：32x32 瓦片，0 间距，0 边距
计算结果：16 列 x 12 行

手动调整：
- 改为 16x16 瓦片
- 添加 1 像素间距
- 添加 2 像素边距

重新计算：30 列 x 22 行
```

### 3. 多选瓦片功能 ✅

**功能**：支持选择多个瓦片

**使用方法**：
1. **单选**：点击瓦片
2. **多选**：按住 Cmd（Mac）或 Ctrl（Windows）+ 点击
3. **框选**：按住鼠标左键拖动选择矩形区域
4. **追加选择**：按住 Cmd/Ctrl + 框选追加到现有选择

**视觉反馈**：
- 选中的瓦片显示蓝色半透明高亮
- 蓝色边框标识选中状态
- 底部显示已选择数量

### 4. 瓦片合并功能 ✅

**功能**：将多个瓦片合并为一个组（Meta Tile）

**使用场景**：
- 大型地形（如 2x2 的树木）
- 重复使用的组合（如 3x2 的建筑物）
- 复杂结构的快速绘制

**使用方法**：

#### 合并瓦片
1. 在瓦片选择器中选择要合并的瓦片（必须是矩形区域）
2. 使用以下方式之一合并：
   - **键盘快捷键**：`Cmd + G`（Mac）或 `Ctrl + G`（Windows）
   - **按钮**：点击"合并瓦片"按钮
3. 系统会提示合并成功，显示合并的尺寸（如 `2x2`）

#### 取消合并
1. 选择已合并组中的任意瓦片
2. 使用以下方式之一取消：
   - **键盘快捷键**：`Cmd + Shift + G`（Mac）或 `Ctrl + Shift + G`（Windows）
   - **按钮**：点击"取消合并"按钮

**限制**：
- 只能合并矩形区域的瓦片
- 选择的瓦片必须连续且无空隙

**示例**：
```
场景：合并 2x2 树木
1. 选择瓦片索引 0, 1, 16, 17（假设每行16个瓦片）
2. 按 Cmd/Ctrl + G
3. 系统提示：已合并 2x2 瓦片
4. 信息面板显示：合并组: 1

使用：
- 在地图上点击时，会绘制整个 2x2 区域
- （注：当前版本绘制时只绘制第一个瓦片，完整实现需要扩展绘制逻辑）
```

### 5. 键盘快捷键 ✅

**所有快捷键**：

| 功能 | Mac | Windows |
|------|-----|---------|
| 合并瓦片 | `Cmd + G` | `Ctrl + G` |
| 取消合并 | `Cmd + Shift + G` | `Ctrl + Shift + G` |
| 平移视图 | `中键拖动` 或 `Alt + 左键拖动` | 同左 |
| 缩放视图 | `滚轮` | `滚轮` |

**提示**：
- 快捷键在整个编辑器窗口中有效
- 无需聚焦特定元素
- 快捷键提示显示在信息面板中

## 📋 完整工作流程

### 创建新地图

1. **上传瓦片集**
   ```
   点击"上传瓦片集" → 选择图片 → 自动识别网格
   ```

2. **调整网格（可选）**
   ```
   在网格设置面板 → 修改参数 → 点击"应用设置"
   ```

3. **选择瓦片**
   ```
   在瓦片选择器中 → 点击或框选瓦片
   ```

4. **合并瓦片（可选）**
   ```
   选中多个瓦片 → Cmd/Ctrl + G → 确认合并
   ```

5. **绘制地图**
   ```
   选择工具（笔刷/橡皮擦）→ 在画布上绘制
   ```

6. **管理图层**
   ```
   点击"添加图层" → 切换图层 → 独立编辑
   ```

7. **导出地图**
   ```
   点击"导出地图" → 保存 JSON 文件
   ```

### 编辑现有地图

1. **导入地图**
   ```
   点击"导入地图" → 选择 JSON 文件 → 自动加载
   ```

2. **选择瓦片集**
   ```
   在瓦片集列表中点击 → 查看/编辑
   ```

3. **继续编辑**
   ```
   选择图层 → 选择工具 → 修改地图
   ```

4. **重新导出**
   ```
   完成编辑 → 导出地图 → 覆盖或另存为
   ```

## 🎯 高级技巧

### 网格识别失败怎么办？

如果自动识别不准确：
1. 查看网格设置面板
2. 手动调整参数
3. 观察预览中的红色网格线
4. 调整直到网格对齐瓦片

### 如何创建复杂结构？

使用合并功能：
1. 选择组成结构的所有瓦片
2. 合并为一个组
3. 绘制时可快速放置整个结构

### 如何提高绘制效率？

1. **使用多图层**
   - 背景层：地面、墙壁
   - 装饰层：植物、物品
   - 前景层：遮挡物

2. **使用合并瓦片**
   - 预先合并常用结构
   - 减少重复操作

3. **快捷键**
   - 熟练使用键盘快捷键
   - 减少鼠标点击

## ⚠️ 注意事项

### 系统要求

- **浏览器**：Chrome 113+, Safari 17.4+, Edge 113+
- **GPU**：支持 WebGPU 的显卡
- **内存**：建议 4GB+ RAM

### 已知限制

1. **合并瓦片绘制**
   - 当前版本只绘制合并组的第一个瓦片
   - 未来版本将支持绘制整个合并组

2. **地图大小**
   - 建议不超过 200x200 瓦片
   - 过大地图可能影响性能

3. **瓦片集数量**
   - 建议不超过 10 个瓦片集
   - 过多会增加内存占用

### 性能优化建议

1. **使用合适的瓦片大小**
   - 推荐：16x16, 32x32, 64x64
   - 避免：过大（>128x128）或过小（<8x8）

2. **控制图层数量**
   - 推荐：3-5 层
   - 避免：超过 10 层

3. **定期保存**
   - 每完成一部分就导出
   - 避免丢失工作

## 🐛 故障排除

### 问题：上传瓦片集后没反应

**解决方案**：
1. 检查浏览器控制台错误
2. 确认图片格式正确（PNG、JPG）
3. 尝试较小的图片
4. 刷新页面重试

### 问题：网格对不齐

**解决方案**：
1. 打开网格设置面板
2. 手动调整瓦片大小
3. 调整间距和边距
4. 观察预览直到对齐

### 问题：合并瓦片失败

**解决方案**：
1. 确保选择的是矩形区域
2. 检查瓦片是否连续
3. 至少选择 2 个瓦片
4. 查看提示信息

### 问题：WebGPU 不支持

**解决方案**：
1. 更新浏览器到最新版本
2. 检查显卡驱动
3. 尝试其他支持 WebGPU 的浏览器
4. 查看浏览器兼容性列表

## 📚 更多资源

- [完整文档](./README.md)
- [快速开始](./QUICKSTART.md)
- [使用示例](./USAGE_EXAMPLE.md)
- [项目结构](./PROJECT_STRUCTURE.md)

---

**享受使用 TileMap 编辑器！** 🗺️

