# TileMap 编辑器 - 雪碧图瓦片系统

## 功能概述

TileMap 编辑器现已支持完整的雪碧图上传和瓦片绘制功能。

## 主要功能

### 1. 雪碧图管理
- **上传雪碧图**：支持同时上传多张图片
- **网格拆分**：每张雪碧图可单独设置行数和列数，自动拆分成瓦片
- **预览瓦片**：在侧边栏查看所有拆分后的瓦片
- **删除管理**：可删除不需要的雪碧图

### 2. 瓦片选择与绘制
- **选择瓦片**：点击 Drawer 中的瓦片作为画笔（青色高亮）
- **多选瓦片**：Shift + 点击可多选瓦片（金色高亮 + ✓标记）
- **合并瓦片**：选中多个相邻瓦片后按 Cmd/Ctrl + G 合并为一个大瓦片
- **绘制瓦片**：在画布上点击或拖拽即可将选中的瓦片绘制到网格中
- **实时预览**：瓦片即时渲染到画布网格

### 3. 画笔模式
- **像素画模式**：像素完美渲染，适合像素艺术（无抗锯齿）
- **插值模式**：平滑插值渲染，适合高清图片（高质量缩放）
- **一键切换**：在画笔设置区域快速切换渲染模式

### 4. 画布操作
- **平移视图**：Space + 左键拖拽 或 中键拖拽
- **缩放视图**：鼠标滚轮缩放（20% - 400%）
- **重置视图**：双击 J 键重置到初始位置
- **网格设置**：可调整网格的行数、列数、单元格尺寸、线宽和颜色
- **网格线切换**：按 L 键快速显示/隐藏网格线

## 使用步骤

### 步骤 1：上传雪碧图
1. 打开 TileMap 编辑器
2. 点击右上角的 "☰ 设置" 按钮打开侧边栏
3. 在"雪碧图管理"区域点击文件上传按钮
4. 选择一张或多张图片上传

### 步骤 2：设置网格拆分
1. 上传成功后，每张雪碧图会显示在列表中
2. 设置该雪碧图的 **行数** 和 **列数**
3. 系统会自动计算瓦片尺寸并拆分
4. 在预览区域查看所有瓦片

### 步骤 3：选择瓦片
1. 在雪碧图的瓦片预览区域，点击任意瓦片
2. 选中的瓦片会有青色高亮边框
3. 视图信息区域会显示当前选中的瓦片位置

### 步骤 4：合并瓦片（可选）
1. 按住 Shift 键点击多个相邻的瓦片（会显示金色高亮）
2. 确保选中的瓦片组成完整的矩形区域
3. 按 Cmd（Mac）或 Ctrl（Windows）+ G 合并瓦片
4. 合并后的瓦片会出现在"合并瓦片库"中
5. 点击合并瓦片可将其作为画笔使用

### 步骤 5：选择画笔模式
1. 在"画笔设置"区域选择渲染模式
2. **像素画**：适合像素艺术，保持锐利边缘
3. **插值**：适合高清图片，平滑缩放

### 步骤 6：绘制瓦片
1. 选中瓦片后，在画布上任意位置点击即可绘制
2. 按住鼠标左键拖拽可连续绘制
3. 瓦片会自动适配网格单元格大小
4. 合并瓦片会占用对应数量的网格单元格

### 步骤 7：使用橡皮擦（可选）
1. 按住 D 键进入橡皮擦模式（会有红色高亮提示）
2. 鼠标悬浮在要删除的瓦片上
3. 瓦片会自动删除（悬浮框显示红色）
4. 释放 D 键退出橡皮擦模式

### 步骤 8：切换网格线显示（可选）
1. 按 L 键隐藏网格线，便于预览最终效果
2. 再按 L 键显示网格线，便于精确编辑
3. 状态会实时显示在视图信息区域

## 快捷键

| 操作 | 快捷键 |
|------|--------|
| 平移画布 | Space + 左键拖拽 或 中键拖拽 |
| 缩放画布 | 鼠标滚轮 |
| 重置视图 | 双击 J |
| 选择瓦片 | 左键点击瓦片预览 |
| 多选瓦片 | Shift + 左键点击瓦片 |
| 合并瓦片 | Cmd/Ctrl + G |
| 绘制瓦片 | 左键点击/拖拽画布 |
| 橡皮擦模式 | 按住 D 键 |
| 切换网格线 | 按 L 键 |

## 技术特性

### 数据结构
- **SpriteSheet**：雪碧图对象，包含图片、行列配置、瓦片尺寸
- **TileData**：瓦片数据，记录每个网格单元格的瓦片信息，支持合并瓦片的行列跨度
- **MergedTile**：合并瓦片对象，记录多个瓦片组成的大瓦片
- **SelectedTile**：当前选中的瓦片（画笔）
- **BrushMode**：画笔渲染模式（像素画/插值）

### 渲染机制
- 使用 Canvas 2D API 绘制瓦片
- 支持两种渲染模式：
  - **像素画模式**：`imageSmoothingEnabled = false`，完美像素渲染
  - **插值模式**：`imageSmoothingQuality = 'high'`，高质量平滑缩放
- 支持合并瓦片的跨单元格渲染
- 自动适配缩放和偏移变换
- 实时响应式绘制

### 性能优化
- 按需重绘画布
- 使用 Map 存储瓦片数据，高效查询
- 图片加载完成后自动刷新显示

## 界面布局

### 主画布
- 中央网格画布，支持无限平移和缩放
- 鼠标悬停高亮当前单元格
- 实时显示绘制的瓦片

### 侧边栏（Drawer）
1. **画笔设置**
   - 像素画/插值模式切换
   - 模式说明提示

2. **合并瓦片库**（有合并瓦片时显示）
   - 合并瓦片列表
   - 点击选择作为画笔
   - 删除合并瓦片

3. **雪碧图管理**
   - 文件上传按钮
   - 多选提示和操作
   - 雪碧图列表
   - 行列配置
   - 瓦片预览和选择
   - 多选高亮和标记
   - 删除按钮

4. **背景设置**
   - 预设颜色（黑色/白色）
   - 自定义颜色选择器

5. **网格设置**
   - 列数/行数
   - 格宽/格高
   - 线宽/线色

6. **视图信息**
   - 缩放比例
   - 偏移位置
   - 悬浮单元格
   - 选中瓦片信息
   - 重置视图按钮

## 示例工作流

### 创建一个简单的关卡
1. 上传地形瓦片雪碧图（如：grass, dirt, stone）
2. 设置 4x4 网格拆分（16个瓦片）
3. 选择草地瓦片，在画布底部绘制地面
4. 选择石头瓦片，在画布上方绘制平台
5. 调整视图缩放和位置查看效果

### 使用多张雪碧图
1. 上传地形雪碧图
2. 上传装饰物雪碧图
3. 上传角色雪碧图
4. 分别设置它们的网格拆分
5. 组合不同雪碧图的瓦片创建场景

### 合并大型对象瓦片
1. 上传包含大型对象的雪碧图（如建筑物、树木）
2. 设置合适的行列拆分
3. 按住 Shift 点击选择组成大对象的多个瓦片（如 2x3 的树）
4. 按 Cmd/Ctrl + G 合并为一个瓦片
5. 在"合并瓦片库"中点击使用
6. 在画布上一次绘制完整的大对象

## 已知限制

- 当前不支持瓦片旋转和翻转
- 不支持多层瓦片叠加
- 不支持导出/导入瓦片地图数据
- 合并瓦片必须是完整的矩形区域

## 后续规划

- [ ] 添加瓦片地图导出功能（JSON格式）
- [ ] 支持瓦片图层管理
- [ ] 添加橡皮擦工具
- [ ] 支持瓦片旋转和镜像
- [ ] 添加填充工具（bucket fill）
- [ ] 支持自动瓦片（auto-tiling）
- [ ] 添加撤销/重做功能
- [ ] 支持框选多选（拖拽选择区域）
- [ ] 合并瓦片预览功能

